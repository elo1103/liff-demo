<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ‰“å¡ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            font-weight: bold;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .greeting {
            font-size: 24px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            color: #718096;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }

        .btn {
            padding: 18px 24px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-clock-in {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-clock-in:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        .btn-clock-out {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-clock-out:hover {
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .result {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px dashed #e2e8f0;
            transition: all 0.3s ease;
        }

        .result.success {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            border-color: #48bb78;
            color: #22543d;
            animation: successPulse 0.5s ease-out;
        }

        @keyframes successPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }

        .result-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .result-text {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .result-time {
            font-size: 12px;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #718096;
            font-size: 16px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 16px;
            font-weight: 600;
            color: #718096;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            bottom: -2px;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            margin-top: 24px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 12px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 16px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            margin-bottom: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
        }

        .btn-view-charts {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            margin-top: 16px;
        }

        .btn-view-charts:hover {
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
            transform: translateY(-2px);
        }

        @media (max-width: 480px) {
            .container {
                padding: 24px;
                border-radius: 16px;
            }

            .greeting {
                font-size: 20px;
            }

            .btn {
                padding: 16px 20px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">
            <div class="spinner"></div>
            <div class="loading-text">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008507273-84v7GBep";
        const SUPABASE_URL = "https://wotnfvxjzrbfqmnvjfsg.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndvdG5mdnhqenJiZnFtbnZqZnNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5OTk5MzQsImV4cCI6MjA2NzU3NTkzNH0.xXVgTF2ULgqGsW19HvjRqzxN0budJPt8kDwTIC5ombQ";

        async function main() {
            await liff.init({ liffId: LIFF_ID });

            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            const profile = await liff.getProfile();
            const userId = profile.userId;

            // å–å¾—ä½¿ç”¨è€…åç¨±çš„ç¬¬ä¸€å€‹å­—ä½œç‚ºé ­åƒ
            const avatarText = profile.displayName.charAt(0).toUpperCase();

            document.getElementById("app").innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="avatar">${avatarText}</div>
                        <div class="greeting">ä½ å¥½ï¼Œ${profile.displayName}</div>
                        <div class="subtitle">è«‹é¸æ“‡æ‰“å¡é¡å‹</div>
                    </div>
                    <div class="tabs">
                        <button class="tab active" data-tab="clock">æ‰“å¡</button>
                        <button class="tab" data-tab="stats">çµ±è¨ˆ</button>
                    </div>
                    <div id="clockTab" class="tab-content active">
                        <div class="button-group">
                            <button id="clockIn" class="btn btn-clock-in">ğŸ“… ä¸Šç­æ‰“å¡</button>
                            <button id="clockOut" class="btn btn-clock-out">ğŸ  ä¸‹ç­æ‰“å¡</button>
                        </div>
                        <div id="result" class="result">
                            <div style="color: #a0aec0; font-size: 14px;">ç­‰å¾…æ‰“å¡...</div>
                        </div>
                    </div>
                    <div id="statsTab" class="tab-content">
                        <div id="statsContent">
                            <div class="loading">
                                <div class="spinner"></div>
                                <div class="loading-text">è¼‰å…¥çµ±è¨ˆè³‡æ–™...</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // æ¨™ç±¤é åˆ‡æ›
            document.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = () => {
                    const targetTab = tab.dataset.tab;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`${targetTab}Tab`).classList.add('active');
                    
                    if (targetTab === 'stats') {
                        loadStatistics(userId);
                    }
                };
            });

            document.getElementById("clockIn").onclick = () => sendAttendance(userId, "clock_in");
            document.getElementById("clockOut").onclick = () => sendAttendance(userId, "clock_out");
        }

        async function sendAttendance(userId, actionType) {
            const clockInBtn = document.getElementById("clockIn");
            const clockOutBtn = document.getElementById("clockOut");
            const resultDiv = document.getElementById("result");

            // ç¦ç”¨æŒ‰éˆ•
            clockInBtn.disabled = true;
            clockOutBtn.disabled = true;

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            resultDiv.className = "result";
            resultDiv.innerHTML = '<div class="spinner" style="width: 30px; height: 30px; border-width: 3px;"></div><div style="margin-top: 8px; color: #718096;">è™•ç†ä¸­...</div>';

            try {
                const timestamp = new Date().toISOString();
                const localTime = new Date().toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                const res = await fetch(`${SUPABASE_URL}/rest/v1/attendance_log`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "apikey": SUPABASE_KEY,
                        "Authorization": `Bearer ${SUPABASE_KEY}`,
                        "Prefer": "return=representation"
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        type: actionType,
                        timestamp: timestamp
                    })
                });

                if (!res.ok) {
                    throw new Error('æ‰“å¡å¤±æ•—');
                }

                const data = await res.json();

                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                resultDiv.className = "result success";
                resultDiv.innerHTML = `
                    <div class="result-icon">${actionType === "clock_in" ? "âœ…" : "ğŸ "}</div>
                    <div class="result-text">${actionType === "clock_in" ? "ä¸Šç­æ‰“å¡æˆåŠŸï¼" : "ä¸‹ç­æ‰“å¡æˆåŠŸï¼"}</div>
                    <div class="result-time">${localTime}</div>
                `;

                console.log("Inserted:", data);
                
                // å¦‚æœç•¶å‰åœ¨çµ±è¨ˆé é¢ï¼Œåˆ·æ–°çµ±è¨ˆæ•¸æ“š
                const statsTab = document.getElementById("statsTab");
                if (statsTab && statsTab.classList.contains("active")) {
                    loadStatistics(userId);
                }
            } catch (error) {
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                resultDiv.className = "result";
                resultDiv.style.background = "#fed7d7";
                resultDiv.style.borderColor = "#fc8181";
                resultDiv.innerHTML = `
                    <div class="result-icon">âŒ</div>
                    <div class="result-text" style="color: #c53030;">æ‰“å¡å¤±æ•—</div>
                    <div class="result-time" style="color: #c53030;">è«‹ç¨å¾Œå†è©¦</div>
                `;
                console.error("Error:", error);
            } finally {
                // é‡æ–°å•Ÿç”¨æŒ‰éˆ•
                clockInBtn.disabled = false;
                clockOutBtn.disabled = false;
            }
        }

        async function fetchAttendanceHistory(userId, days = 30) {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);

            const res = await fetch(
                `${SUPABASE_URL}/rest/v1/attendance_log?user_id=eq.${userId}&timestamp=gte.${startDate.toISOString()}&timestamp=lte.${endDate.toISOString()}&order=timestamp.asc`,
                {
                    headers: {
                        "apikey": SUPABASE_KEY,
                        "Authorization": `Bearer ${SUPABASE_KEY}`
                    }
                }
            );

            if (!res.ok) {
                throw new Error('ç²å–æ‰“å¡è¨˜éŒ„å¤±æ•—');
            }

            return await res.json();
        }

        function calculateWorkHours(records) {
            const dailyHours = {};
            const clockIns = [];
            const clockOuts = [];

            // åˆ†é›¢ä¸Šç­å’Œä¸‹ç­è¨˜éŒ„
            records.forEach(record => {
                const date = new Date(record.timestamp);
                const dateKey = date.toISOString().split('T')[0];
                
                if (!dailyHours[dateKey]) {
                    dailyHours[dateKey] = { clockIn: null, clockOut: null };
                }

                if (record.type === 'clock_in') {
                    dailyHours[dateKey].clockIn = date;
                    clockIns.push({ date: dateKey, time: date });
                } else if (record.type === 'clock_out') {
                    dailyHours[dateKey].clockOut = date;
                    clockOuts.push({ date: dateKey, time: date });
                }
            });

            // è¨ˆç®—æ¯æ—¥å·¥æ™‚
            const hoursData = [];
            Object.keys(dailyHours).sort().forEach(dateKey => {
                const day = dailyHours[dateKey];
                if (day.clockIn && day.clockOut) {
                    const hours = (day.clockOut - day.clockIn) / (1000 * 60 * 60);
                    hoursData.push({
                        date: dateKey,
                        hours: parseFloat(hours.toFixed(2)),
                        clockIn: day.clockIn,
                        clockOut: day.clockOut
                    });
                }
            });

            return hoursData;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        function formatHours(hours) {
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            return m > 0 ? `${h}å°æ™‚${m}åˆ†é˜` : `${h}å°æ™‚`;
        }

        async function loadStatistics(userId) {
            const statsContent = document.getElementById("statsContent");
            
            try {
                console.log('é–‹å§‹è¼‰å…¥çµ±è¨ˆè³‡æ–™...');
                const records = await fetchAttendanceHistory(userId, 30);
                console.log('ç²å–åˆ°è¨˜éŒ„æ•¸:', records.length);
                const hoursData = calculateWorkHours(records);
                console.log('è¨ˆç®—å¾Œçš„å·¥æ™‚æ•¸æ“š:', hoursData);

                if (hoursData.length === 0) {
                    statsContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“Š</div>
                            <div>å°šç„¡æ‰“å¡è¨˜éŒ„</div>
                        </div>
                    `;
                    return;
                }

                // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
                const totalHours = hoursData.reduce((sum, day) => sum + day.hours, 0);
                const avgHours = totalHours / hoursData.length;
                const thisWeekHours = hoursData
                    .filter(day => {
                        const dayDate = new Date(day.date);
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return dayDate >= weekAgo;
                    })
                    .reduce((sum, day) => sum + day.hours, 0);
                const workDays = hoursData.length;

                // æº–å‚™åœ–è¡¨æ•¸æ“šï¼ˆæœ€è¿‘7å¤©ï¼Œå¦‚æœä¸è¶³7å¤©å‰‡é¡¯ç¤ºæ‰€æœ‰æ•¸æ“šï¼‰
                const recentDays = hoursData.slice(-7);
                const chartLabels = recentDays.length > 0 
                    ? recentDays.map(day => formatDate(day.date))
                    : [];
                const chartData = recentDays.length > 0
                    ? recentDays.map(day => day.hours)
                    : [];

                statsContent.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${formatHours(totalHours)}</div>
                            <div class="stat-label">ç¸½å·¥æ™‚</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatHours(avgHours)}</div>
                            <div class="stat-label">å¹³å‡æ¯æ—¥</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatHours(thisWeekHours)}</div>
                            <div class="stat-label">æœ¬é€±å·¥æ™‚</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${workDays}</div>
                            <div class="stat-label">å·¥ä½œå¤©æ•¸</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">æœ€è¿‘7å¤©å·¥æ™‚è¶¨å‹¢</div>
                        <div class="chart-wrapper">
                            <canvas id="dailyHoursChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">æ¯æ—¥å·¥æ™‚åˆ†ä½ˆ</div>
                        <div class="chart-wrapper">
                            <canvas id="hoursDistributionChart"></canvas>
                        </div>
                    </div>
                `;

                // ç­‰å¾… DOM æ›´æ–°å¾Œå†å‰µå»ºåœ–è¡¨
                setTimeout(() => {
                    // æª¢æŸ¥ Chart.js æ˜¯å¦å·²è¼‰å…¥
                    if (typeof Chart === 'undefined') {
                        console.error('Chart.js æœªè¼‰å…¥');
                        statsContent.innerHTML += `
                            <div style="text-align: center; padding: 20px; color: #c53030;">
                                <div>åœ–è¡¨åº«è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>
                            </div>
                        `;
                        return;
                    }

                    console.log('æº–å‚™å‰µå»ºåœ–è¡¨ï¼Œæ•¸æ“šé»æ•¸:', chartData.length);
                    console.log('åœ–è¡¨æ¨™ç±¤:', chartLabels);
                    console.log('åœ–è¡¨æ•¸æ“š:', chartData);

                    // å‰µå»ºæ¯æ—¥å·¥æ™‚æŠ˜ç·šåœ–
                    const dailyCtx = document.getElementById('dailyHoursChart');
                    if (!dailyCtx) {
                        console.error('æ‰¾ä¸åˆ° dailyHoursChart canvas');
                        return;
                    }
                    
                    console.log('å‰µå»ºæŠ˜ç·šåœ–...');
                    new Chart(dailyCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'å·¥æ™‚ï¼ˆå°æ™‚ï¼‰',
                            data: chartData,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: 'rgb(102, 126, 234)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `å·¥æ™‚: ${formatHours(context.parsed.y)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + 'h';
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                    });

                    // å‰µå»ºæ¯æ—¥å·¥æ™‚é•·æ¢åœ–
                    const distCtx = document.getElementById('hoursDistributionChart');
                    if (!distCtx) {
                        console.error('æ‰¾ä¸åˆ° hoursDistributionChart canvas');
                        return;
                    }
                    
                    console.log('å‰µå»ºé•·æ¢åœ–...');
                    new Chart(distCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'å·¥æ™‚ï¼ˆå°æ™‚ï¼‰',
                            data: chartData,
                            backgroundColor: chartData.map((_, i) => 
                                `hsl(${220 + i * 10}, 70%, ${60 + i * 5}%)`
                            ),
                            borderColor: 'rgb(102, 126, 234)',
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `å·¥æ™‚: ${formatHours(context.parsed.y)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + 'h';
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                    });
                    
                    console.log('åœ–è¡¨å‰µå»ºå®Œæˆï¼');
                }, 100); // çµ¦ DOM ä¸€é»æ™‚é–“æ›´æ–°

            } catch (error) {
                statsContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #c53030;">
                        <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                        <div>è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—</div>
                        <div style="font-size: 12px; margin-top: 8px; color: #718096;">${error.message}</div>
                    </div>
                `;
                console.error("Error loading statistics:", error);
            }
        }

        main();
    </script>
</body>
</html>

