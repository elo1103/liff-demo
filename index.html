<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>打卡系統</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<h2>Loading...</h2>

<script>
const LIFF_ID = "2008507273-84v7GBep";
const SUPABASE_URL = "https://wotnfvxjzrbfqmnvjfsg.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndvdG5mdnhqenJiZnFtbnZqZnNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5OTk5MzQsImV4cCI6MjA2NzU3NTkzNH0.xXVgTF2ULgqGsW19HvjRqzxN0budJPt8kDwTIC5ombQ";

async function main() {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
        liff.login();
        return;
    }

    const profile = await liff.getProfile();
    const userId = profile.userId;

    document.body.innerHTML = `
        <h1>Hi, ${profile.displayName}</h1>
        <button id="clockIn">上班</button>
        <button id="clockOut">下班</button>
        <p id="result"></p>
    `;

    document.getElementById("clockIn").onclick = () => sendAttendance(userId, "clock_in");
    document.getElementById("clockOut").onclick = () => sendAttendance(userId, "clock_out");
}

async function sendAttendance(userId, actionType) {
    const timestamp = new Date().toISOString();

    const res = await fetch(`${SUPABASE_URL}/rest/v1/attendance_logs`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_KEY,
            "Authorization": `Bearer ${SUPABASE_KEY}`,
            "Prefer": "return=representation"
        },
        body: JSON.stringify({
            user_id: userId,
            action: actionType,
            timestamp: timestamp
        })
    });

    const data = await res.json();

    document.getElementById("result").innerText =
        actionType === "clock_in"
        ? "✔ 上班打卡成功！\n" + timestamp
        : "✔ 下班打卡成功！\n" + timestamp;

    console.log("Inserted:", data);
}

main();
</script>
</body>
</html>
